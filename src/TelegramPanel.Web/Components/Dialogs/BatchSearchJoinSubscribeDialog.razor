@namespace TelegramPanel.Web.Components.Dialogs
@inject AccountManagementService AccountManagement
@inject TelegramPanel.Core.Services.AccountRiskService RiskService
@inject BatchTaskManagementService TaskManagement
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using System.Text.Json
@using TelegramPanel.Core.BatchTasks
@using TelegramPanel.Data.Entities

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                将使用选中的 <strong>@accounts.Count</strong> 个账号搜索并订阅指定用户名的频道/群组
            </MudAlert>

            <MudTextField @bind-Value="username"
                          Label="目标用户名"
                          Variant="Variant.Outlined"
                          Placeholder="输入用户名"
                          HelperText="每个账号都会搜索此用户名，找到后自动订阅"
                          Immediate="false" />

            <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Dense="true">
                <MudText Typo="Typo.body2">
                    <strong>工作原理：</strong>
                </MudText>
                <MudText Typo="Typo.body2" Class="mt-1">
                    1. 每个账号都会搜索指定的用户名<br/>
                    2. 如果找到对应的频道/群组，自动订阅<br/>
                    3. 如果搜索不到或已订阅，跳过该账号<br/>
                    4. 所有操作都会记录在任务日志中
                </MudText>
            </MudAlert>

            <MudNumericField @bind-Value="delayMs" 
                             Label="操作间隔（毫秒）" 
                             Variant="Variant.Outlined" 
                             Min="1000" 
                             Max="10000"
                             HelperText="建议设置 2000-5000ms，避免触发风控（会额外加少量随机抖动）。" />

            @if (accounts.Count > 0)
            {
                <MudPaper Class="pa-2" Elevation="0" Outlined="true">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">将执行的账号列表：</MudText>
                    <MudStack Spacing="1" Style="max-height: 200px; overflow-y: auto;">
                        @foreach (var account in accounts.Take(10))
                        {
                            <MudText Typo="Typo.body2">
                                • @account.DisplayPhone 
                                @if (!string.IsNullOrWhiteSpace(account.Nickname))
                                {
                                    <span style="color: #888;">(@account.Nickname)</span>
                                }
                            </MudText>
                        }
                        @if (accounts.Count > 10)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                ... 还有 @(accounts.Count - 10) 个账号
                            </MudText>
                        }
                    </MudStack>
                </MudPaper>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="Cancel" Disabled="@submitting">关闭</MudButton>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="Submit" 
                   Disabled="@(submitting || accounts.Count == 0 || string.IsNullOrWhiteSpace(username))">
            @if (submitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>提交中...</span>
            }
            else
            {
                <span>开始执行</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code
{
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public List<int> AccountIds { get; set; } = new();

    private List<Account> accounts = new();
    private string username = "";
    private int delayMs = 3000;
    private bool submitting;

    protected override async Task OnInitializedAsync()
    {
        if (AccountIds.Count == 0)
            return;

        // 加载账号信息
        foreach (var accountId in AccountIds)
        {
            var account = await AccountManagement.GetAccountAsync(accountId);
            if (account != null)
            {
                accounts.Add(account);
            }
        }
    }

    private async Task Submit()
    {
        if (submitting || accounts.Count == 0 || string.IsNullOrWhiteSpace(username))
            return;

        var normalizedUsername = username.Trim().TrimStart('@');
        if (string.IsNullOrWhiteSpace(normalizedUsername))
        {
            Snackbar.Add("请输入有效的用户名", Severity.Warning);
            return;
        }

        // 风控检查：搜索订阅是敏感操作
        var batchCheck = RiskService.CheckBatchAccounts(accounts);
        if (batchCheck.HasRiskyAccounts)
        {
            var parameters = new DialogParameters
            {
                ["Message"] = $"检测到 {batchCheck.RiskyCount} 个风险账号",
                ["DetailedMessage"] = batchCheck.GetRiskySummary(),
                ["ShowRecommendations"] = true,
                ["ShowExcludeOption"] = false,
                ["RiskyAccounts"] = batchCheck.RiskyAccounts.ToList()
            };
            var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large };
            var dialog = DialogService.Show<RiskWarningDialog>("批量操作风控警告", parameters, options);
            var result = await dialog.Result;
            if (result.Canceled)
                return;
        }

        bool? confirm = await DialogService.ShowMessageBox(
            "确认执行",
            $"将使用 {accounts.Count} 个账号搜索并订阅 @{normalizedUsername}。\n\n每个账号都会尝试搜索此用户名，找到后自动订阅。是否继续？",
            yesText: "继续", cancelText: "取消");

        if (confirm != true)
            return;

        submitting = true;
        try
        {
            var task = new BatchTask
            {
                TaskType = BatchTaskTypes.UserJoinSubscribe,
                Total = accounts.Count,
                Completed = 0,
                Failed = 0,
                Config = JsonSerializer.Serialize(new
                {
                    AccountIds = accounts.Select(a => a.Id).ToList(),
                    SearchUsername = normalizedUsername,
                    DelayMs = delayMs
                })
            };

            var created = await TaskManagement.CreateTaskAsync(task);
            Snackbar.Add($"已提交后台任务 #{created.Id}（批量搜索订阅 @{normalizedUsername}）。请到【任务中心】查看进度。", Severity.Success);
            MudDialog.Close(DialogResult.Ok(created.Id));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"提交失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            submitting = false;
        }
    }

    private void Cancel() => MudDialog.Close();
}

