@page "/channels/groups"
@inject ChannelGroupManagementService GroupManagement
@inject ChannelManagementService ChannelManagement
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using TelegramPanel.Data.Entities

<PageTitle>频道分组 - Telegram Panel</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">频道分组管理</MudText>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">添加分组</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudTextField @bind-Value="newGroupName" Label="分组名称" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="newGroupDesc" Label="描述" Variant="Variant.Outlined" Lines="3" Class="mt-3" />
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                           Disabled="@string.IsNullOrEmpty(newGroupName)" OnClick="AddGroup">
                    添加分组
                </MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="8">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">分组列表</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudTable Items="@groups" Hover="true" Loading="@loading">
                    <HeaderContent>
                        <MudTh>分组名称</MudTh>
                        <MudTh>描述</MudTh>
                        <MudTh>频道数量</MudTh>
                        <MudTh>操作</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="分组名称">@context.Name</MudTd>
                        <MudTd DataLabel="描述">@(context.Description ?? "-")</MudTd>
                        <MudTd DataLabel="频道数量">@context.Channels.Count</MudTd>
                        <MudTd DataLabel="操作">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                           OnClick="@(() => DeleteGroup(context))" />
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>暂无分组，请添加分组</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudCardContent>
        </MudCard>

        <MudCard Class="mt-4">
            <MudCardHeader>
                <MudText Typo="Typo.h6">分组绑定频道</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudSelect @bind-Value="assignGroupId" Label="选择分组" Variant="Variant.Outlined" Dense="true"
                           @bind-Value:after="OnAssignGroupChanged">
                    <MudSelectItem Value="0">-- 请选择分组 --</MudSelectItem>
                    @foreach (var g in groups)
                    {
                        <MudSelectItem Value="@g.Id">@g.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudTable Items="@channels" Hover="true" Dense="true" Class="mt-3"
                          MultiSelection="true" @bind-SelectedItems="selectedChannels"
                          Loading="@channelsLoading">
                    <HeaderContent>
                        <MudTh>频道名称</MudTh>
                        <MudTh>用户名</MudTh>
                        <MudTh>创建账号</MudTh>
                        <MudTh>当前分组</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="频道名称">@context.Title</MudTd>
                        <MudTd DataLabel="用户名">@(string.IsNullOrWhiteSpace(context.Username) ? "-" : context.Username)</MudTd>
                        <MudTd DataLabel="创建账号">@(context.CreatorAccount?.Phone ?? context.CreatorAccountId.ToString())</MudTd>
                        <MudTd DataLabel="当前分组">@(context.Group?.Name ?? "未分组")</MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>暂无频道数据</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           Disabled="@(assignGroupId == 0 || channelsLoading)"
                           OnClick="@(async (MouseEventArgs _) => await SaveGroupAssignments())">
                    保存勾选到分组
                </MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private string newGroupName = "";
    private string newGroupDesc = "";
    private List<ChannelGroup> groups = new();
    private bool loading = true;

    private List<Channel> channels = new();
    private bool channelsLoading = true;
    private int assignGroupId = 0;
    private HashSet<Channel> selectedChannels = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadGroups();
        await LoadChannels();
    }

    private async Task LoadGroups()
    {
        loading = true;
        try
        {
            var result = await GroupManagement.GetAllGroupsAsync();
            groups = result.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadChannels()
    {
        channelsLoading = true;
        try
        {
            var list = await ChannelManagement.GetAllChannelsAsync();
            channels = list.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载频道失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            channelsLoading = false;
        }
    }

    private Task OnAssignGroupChanged()
    {
        selectedChannels = assignGroupId <= 0
            ? new HashSet<Channel>()
            : channels.Where(c => c.GroupId == assignGroupId).ToHashSet();
        return Task.CompletedTask;
    }

    private async Task SaveGroupAssignments()
    {
        if (assignGroupId <= 0)
        {
            Snackbar.Add("请选择分组", Severity.Error);
            return;
        }

        try
        {
            var currentlyInGroup = channels.Where(c => c.GroupId == assignGroupId).ToList();
            var selected = selectedChannels.ToHashSet();

            // 取消勾选的 -> 移出分组
            foreach (var channel in currentlyInGroup.Where(c => !selected.Contains(c)))
            {
                await ChannelManagement.UpdateChannelGroupAsync(channel.Id, null);
            }

            // 新勾选的 -> 加入分组
            foreach (var channel in selected.Where(c => c.GroupId != assignGroupId))
            {
                await ChannelManagement.UpdateChannelGroupAsync(channel.Id, assignGroupId);
            }

            await LoadChannels();
            selectedChannels = channels.Where(c => c.GroupId == assignGroupId).ToHashSet();
            Snackbar.Add("分组绑定已保存", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"保存失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task AddGroup()
    {
        try
        {
            var group = new ChannelGroup
            {
                Name = newGroupName,
                Description = newGroupDesc,
                CreatedAt = DateTime.UtcNow
            };

            await GroupManagement.CreateGroupAsync(group);
            await LoadGroups();
            Snackbar.Add($"分组 \"{newGroupName}\" 添加成功", Severity.Success);

            newGroupName = "";
            newGroupDesc = "";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"添加失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteGroup(ChannelGroup group)
    {
        bool? result = await DialogService.ShowMessageBox(
            "确认删除",
            $"确定要删除分组 {group.Name} 吗？关联的频道将变为未分组。",
            yesText: "删除", cancelText: "取消");

        if (result == true)
        {
            try
            {
                await GroupManagement.DeleteGroupAsync(group.Id);
                groups.Remove(group);
                Snackbar.Add("删除成功", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"删除失败：{ex.Message}", Severity.Error);
            }
        }
    }
}
