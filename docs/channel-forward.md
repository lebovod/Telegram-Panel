# 频道转发功能说明

## 功能概述

频道转发功能允许您使用 Telegram 机器人自动监听指定频道的消息，并将其转发到其他频道。支持文本处理、关键词过滤和自定义底部模板。

## 功能特点

- ✅ **自动监听**：机器人自动监听源频道的新消息
- ✅ **智能过滤**：支持删除链接、用户名提及和自定义关键词
- ✅ **批量转发**：一条消息可以同时转发到多个目标频道
- ✅ **自定义模板**：可以在转发消息底部添加自定义内容
- ✅ **统计功能**：记录转发成功和跳过的消息数量

## 使用步骤

### 1. 准备工作

1. 确保您已经添加了至少一个机器人（在"机器人管理"中）
2. 机器人必须是源频道和目标频道的管理员
3. 机器人需要有发送消息的权限

### 2. 创建转发规则

1. 进入 **机器人管理 -> 频道转发**
2. 点击"新建转发规则"
3. 填写以下信息：

#### 基本设置

- **规则名称**：给规则起一个容易识别的名字
- **使用的机器人**：选择用于转发的机器人
- **源频道ID**：要监听的频道ID（如：`-1001234567890`）
  - 可以使用频道ID或用户名（如：`@channelname`）
  - 获取频道ID方法：将机器人添加为频道管理员后，在 Bot 频道列表中查看
- **目标频道ID列表**：要转发到的频道ID，多个用逗号分隔
  - 例如：`-1001234567890,-1009876543210`

#### 文本处理选项

- **删除链接**：自动删除消息中的 http/https 链接
- **删除用户名提及**：自动删除消息中的 @username
- **删除关键词后面的内容**：
  - 每行一个关键词
  - 找到关键词后，删除该关键词及其后面的所有内容
  - 示例：
    ```
    ✅ CẬP NHẬT TIN
    #付费广告
    关注我们
    ```
- **自定义删除正则表达式**：
  - 每行一个正则表达式
  - 匹配的内容将被删除
  - 高级用户使用

#### 底部模板

- 在"帖子底部附加内容"中输入要添加的内容
- 支持 Markdown 格式
- 示例：
  ```
  📢 订阅我们的频道：@yourchannel
  💬 交流群组：@yourgroup
  ```

### 3. 启用规则

- 创建规则后，确保"启用此规则"开关是打开的
- 可以随时在规则列表中切换启用/禁用状态

## 工作原理

1. **监听**：机器人通过 Bot API 的 getUpdates 方法监听源频道的新消息
2. **处理**：根据配置的规则处理消息文本
   - 删除指定的关键词后面的内容
   - 删除链接和用户名提及
   - 应用自定义正则表达式
3. **添加底部**：在处理后的文本底部添加自定义模板
4. **转发**：将处理后的消息转发到所有目标频道
5. **统计**：记录转发成功和跳过的消息数量

## 注意事项

### 权限要求

- 机器人必须是源频道的管理员（至少有"查看消息"权限）
- 机器人必须是目标频道的管理员（至少有"发送消息"权限）
- 如果权限不足，转发会失败

### 频道ID获取

1. **方法一**：通过 Bot 频道列表
   - 将机器人添加为频道管理员
   - 在"Bot 频道"页面查看频道ID

2. **方法二**：使用第三方工具
   - 使用 @userinfobot 等机器人
   - 转发频道消息给机器人即可获取ID

### 消息类型支持

当前版本支持：
- ✅ 纯文本消息
- ✅ 图片消息（含文字说明）
- ✅ 视频消息（含文字说明）
- ✅ 文档消息（含文字说明）

暂不支持：
- ❌ 消息组（多张图片）
- ❌ 投票
- ❌ 音频文件

### 性能建议

- 建议每个机器人监听的源频道不超过 10 个
- 如果消息量很大，建议使用多个机器人分担负载
- 转发延迟通常在 1-3 秒之间

## 故障排除

### 消息没有被转发

1. 检查规则是否启用
2. 确认机器人在源频道和目标频道都有管理员权限
3. 查看系统日志中是否有错误信息
4. 确认源频道ID是否正确

### 消息被过滤掉了

1. 检查"删除关键词后面的内容"配置
2. 检查是否启用了"删除链接"或"删除用户名提及"
3. 如果处理后文本为空，消息会被跳过

### 底部模板没有显示

1. 确认"帖子底部附加内容"字段不为空
2. 检查是否使用了正确的 Markdown 格式
3. 某些特殊字符可能需要转义

## 示例配置

### 示例1：简单转发

```
规则名称：新闻频道转发
源频道ID：-1001234567890
目标频道ID：-1009876543210
底部模板：📢 来源：原创新闻频道
```

### 示例2：过滤广告

```
规则名称：过滤广告转发
源频道ID：@sourcechannel
目标频道ID：-1009876543210,-1001111111111
删除链接：✅
删除用户名提及：✅
删除关键词：
  #付费广告
  #友情广告
  ✅ 关注我们
底部模板：
  📢 订阅频道：@mychannel
  💬 交流群组：@mygroup
```

## 技术架构

- **数据库表**：`ChannelForwardRules` - 存储转发规则
- **后台服务**：`ChannelForwardMonitorService` - 监听和转发服务
- **管理服务**：`ChannelForwardManagementService` - 规则管理
- **UI组件**：
  - `ChannelForwardRules.razor` - 规则列表页面
  - `ChannelForwardRuleDialog.razor` - 规则编辑对话框

## 未来计划

- [ ] 支持消息组（多张图片）转发
- [ ] 支持 AI 文本改写
- [ ] 支持定时转发
- [ ] 支持转发到多个机器人
- [ ] 支持更复杂的过滤规则
- [ ] 支持转发统计图表

## 参考资料

- 参考了 Python 脚本：`新建文件夹/main.py`
- Telegram Bot API 文档：https://core.telegram.org/bots/api

